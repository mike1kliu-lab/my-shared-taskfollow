<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ä»»åŠ¡è¿½è¸ªè¡¨æ ¼ï¼ˆåˆ†é¡µ + å¯ç¼–è¾‘ + è‡ªå®šä¹‰æ¨ªå‘æ»šåŠ¨æ¡ + å­ä»»åŠ¡æŠ˜å æŸ¥çœ‹ï¼‰</title>
<style>
    *{
        box-sizing:border-box;
        margin:0;
        padding:0;
        font-family:"Segoe UI","Microsoft YaHei",sans-serif;
    }
    body{
        background:#121212;
        padding:20px;
        color:#e0e0e0;
    }
    .container{
        max-width:1200px;
        margin:auto;
    }
    h1{
        text-align:center;
        margin-bottom:20px;
        font-size:28px;
    }
    .instructions{
        background:#1e1e1e;
        padding:15px;
        border-radius:8px;
        margin-bottom:20px;
        border-left:4px solid #2196f3;
    }
    .instructions h2{margin-bottom:10px;color:#4fc3f7;}
    .instructions li{margin-bottom:8px;color:#bbbbbb;}
    .table-wrapper{
        position:relative;
        margin-bottom:20px;
    }
    .table-container{
        overflow-x:auto;
        background:#1e1e1e;
        border-radius:10px;
        box-shadow:0 4px 12px rgba(0,0,0,.5);
        padding:20px;
    }
    table{
        width:100%;
        border-collapse:collapse;
        min-width:800px;
    }
    th{
        background:#2c3e50;
        color:#fff;
        padding:15px 10px;
        text-align:center;
        cursor:pointer;
        transition:bg .3s;
        border-bottom:1px solid #333;
    }
    th:hover{background:#34495e;}
    .task-cell{
        border:1px solid #333;
        padding:12px;
        position:relative;
        background:#2b2b2b;
        transition:bg .2s;
    }
    .task-cell:hover{background:#333;}
    .sub-task-cell{
        border:1px solid #444;
        padding:12px;
        position:relative;
        background:#333;
        transition:bg .2s;
    }
    .sub-task-cell:hover{background:#3a3a3a;}
    .sub-task-cell.collapsed{
        display:none;
    }
    .status-indicator{
        position:absolute;
        top:8px;
        right:8px;
        width:16px;
        height:16px;
        border-radius:3px;
        z-index:2;
        cursor:pointer;   /* è®©å·¦é”®ç‚¹å‡»æœ‰æ‰‹å‹ */
    }
    .status-green{background:#4CAF50;}
    .status-yellow{background:#FFC107;}
    .status-red{background:#F44336;}
    .cell-controls{
        position:absolute;
        top:30px;
        right:8px;
        display:flex;
        gap:4px;
        z-index:3;
    }
    .add-cell-btn,.delete-cell-btn{
        width:24px;height:24px;
        border:none;
        display:flex;
        align-items:center;
        justify-content:center;
        cursor:pointer;
        font-weight:bold;
        font-size:14px;
        transition:all .2s;
    }
    .add-cell-btn{
        background:#4CAF50;color:#fff;
    }
    .add-cell-btn:hover{background:#388E3C;}
    .delete-cell-btn{
        background:#F44318;color:#fff;
    }
    .delete-cell-btn:hover{background:#D32F2F;}
    .checkbox-container{
        position:absolute;
        top:8px;
        left:8px;
        z-index:2;
    }
    .task-checkbox{
        width:18px;height:18px;
        cursor:pointer;
    }
    .cell-content{
        padding:30px 40px 0 30px;
        word-break:break-word;
        line-height:1.4;
    }
    .sub-cell-content{
        margin-left:2ch;
        padding:60px 0 0 0;
        word-break:break-word;
        line-height:1.4;
    }
    .cell-input,
    .sub-cell-input{
        width:100%;
        min-height:24px;
        border:none;
        outline:none;
        background:transparent;
        color:#e0e0e0;
        font-family:inherit;
        font-size:inherit;
        white-space:pre-wrap;
        word-break:break-word;
    }
    .cell-input::placeholder,
    .sub-cell-input::placeholder{
        color:#777;
    }
    .expand-indicator{
        width:24px;height:24px;
        border-radius:50%;
        background:#2196F3;color:#fff;
        display:flex;
        align-items:center;
        justify-content:center;
        cursor:pointer;
        font-weight:bold;
        font-size:16px;
        transition:all .2s;
    }
    .expand-indicator:hover{
        background:#0b7dda;
        transform:scale(1.1);
    }
    /* ---------- è¿™é‡Œæ”¹ä¸ºæ¨ªå‘å¸ƒå±€ï¼Œä¸¤ä¸ªæŒ‰é’®å¹¶æ’ ---------- */
    .sub-left-controls{
        position:absolute;
        top:8px;
        left:30px;
        display:flex;
        align-items:center;
        gap:4px;
        z-index:3;
    }
    .sub-history-btn{
        width:auto;
        height:28px;
        border:none;
        background:transparent;
        color:#e0e0e0;
        font-size:14px;
        cursor:pointer;
        display:flex;
        align-items:center;
        gap:8px;
        padding:0 10px;
        border-radius:4px;
        transition:background .2s;
    }
    .sub-history-btn:hover{
        background:#444;
    }
    .sub-history-btn .count{
        color:#aaa;
        font-size:12px;
        font-weight:bold;
    }
    .legend{
        display:flex;
        justify-content:center;
        gap:20px;
        margin-top:20px;
        flex-wrap:wrap;
    }
    .legend-item{display:flex;align-items:center;gap:8px;}
    .legend-color{
        width:20px;height:20px;
        border-radius:3px;
    }
    .actions{
        display:flex;
        justify-content:center;
        gap:15px;
        margin-top:20px;
    }
    .pagination{
        display:flex;
        justify-content:center;
        align-items:center;
        gap:12px;
        margin-top:15px;
    }
    .pagination button{
        width:36px;height:36px;
        border:none;
        border-radius:6px;
        background:#2196F3;
        color:#fff;
        font-size:20px;
        cursor:pointer;
        transition:background .2s;
    }
    .pagination button:hover{background:#0b7dda;}
    .pagination button:disabled{
        background:#555;
        cursor:not-allowed;
    }
    button{
        padding:10px 20px;
        border:none;
        border-radius:6px;
        cursor:pointer;
        font-weight:600;
        transition:all .2s;
        color:#fff;
    }
    .add-task-btn{background:#2196F3;}
    .add-task-btn:hover{background:#0b7dda;}
    .reset-btn{background:#9E9E9E;}
    .reset-btn:hover{background:#757575;}
    .save-btn{background:#66BB6A;}
    .save-btn:hover{background:#4CAF00;}
    .empty-cell{
        border:1px solid #333;
        background:#2b2b2b;
    }
    .scrollbar{
        height:12px;
        margin-top:8px;
        user-select:none;
    }
    .scrollbar .track{
        width:100%;
        height:8px;
        background:#444;
        border-radius:4px;
        position:relative;
        cursor:pointer;
    }
    .scrollbar .thumb{
        height:100%;
        width:60px;
        background:#2196F3;
        border-radius:4px;
        position:absolute;
        left:0;
        top:0;
        cursor:pointer;
        transition:background .2s;
    }
    .scrollbar .thumb:hover{
        background:#0b7dda;
    }
    /* æµ®å±‚æ ·å¼ */
    .history-popover{
        position:absolute;
        background:#2c2c2c;
        border:1px solid #444;
        border-radius:6px;
        box-shadow:0 4px 12px rgba(0,0,0,0.5);
        z-index:1000;
        max-width:300px;
        min-width:200px;
        padding:10px;
        font-size:14px;
        color:#e0e0e0;
        max-height:300px;
        overflow-y:auto;
    }
    .history-item{
        padding:8px 0;
        border-bottom:1px solid #444;
        display:flex;
        align-items:center;
    }
    .history-item:last-child{
        border-bottom:none;
    }
    .history-content{
        font-size:13px;
        color:#bbb;
        margin-top:4px;
        flex-grow:1;
    }
    .history-time{
        font-size:11px;
        color:#888;
        margin-top:2px;
        margin-right:8px;
    }
    .restore-btn{
        width:24px;
        height:24px;
        display:flex;
        align-items:center;
        justify-content:center;
        cursor:pointer;
        font-weight:bold;
        font-size:14px;
        color:#e0e0e0;
        transition:color .2s;
        margin-left:auto;
    }
    .restore-btn:hover{
        color:#2196F3;
        background:rgba(33,150,243,0.1);
        border-radius:4px;
    }
    @media(max-width:768px){
        .table-container{padding:10px;}
        th,.task-cell,.sub-task-cell{padding:10px 5px;}
        .cell-content,.sub-cell-content{font-size:14px;padding:30px 40px 0 30px;}
        .sub-history-btn{font-size:12px;}
    }
    .no-select{
        user-select:none;
    }
</style>
</head>
<body>
<div class="container">
    <h1>ä»»åŠ¡è¿½è¸ªè¡¨æ ¼</h1>

    <div class="instructions">
        <h2>ä½¿ç”¨è¯´æ˜</h2>
        <ul>
            <li><strong>ç‚¹å‡»æ–‡å­—å³å¯ç¼–è¾‘</strong>ï¼ˆå›è½¦æ¢è¡Œï¼‰ï¼Œå¤±ç„¦åè‡ªåŠ¨ä¿å­˜</li>
            <li><strong>å‹¾é€‰å¤é€‰æ¡†</strong>ï¼šé”å®šä»»åŠ¡çŠ¶æ€ï¼ˆä¿æŒç»¿è‰²ï¼‰</li>
            <li><strong>ç‚¹å‡»è¡¨å¤´</strong>ï¼šåªæ˜¾ç¤ºè¯¥åˆ—ä»»åŠ¡</li>
            <li><strong>åŒå‡»è¡¨å¤´</strong>ï¼šç¼–è¾‘ä»»åŠ¡ï¼ˆåˆ—ï¼‰åç§°</li>
            <li><strong>ç‚¹å‡»å·¦ä¾§ä¸‰è§’</strong>ï¼šå±•å¼€å­ä»»åŠ¡åˆ—ï¼ˆå³ä¾§å‡ºç°æ–°åˆ—ï¼Œå…¶ä»–åˆ—æ•´ä½“å³ç§»ï¼‰</li>
            <li><strong>çŠ¶æ€æŒ‡ç¤ºç¯</strong>ï¼šç»¿è‰²&lt;12â€¯hï¼Œé»„è‰²&lt;24â€¯hï¼Œçº¢è‰²â‰¥24â€¯hï¼ˆå¯è‡ªå®šä¹‰çº¢è‰²é˜ˆå€¼ï¼‰</li>
            <li><strong>å³é”®çŠ¶æ€å°æ–¹å—</strong>ï¼šæŸ¥çœ‹è¯¥å•å…ƒæ ¼è·ç¦»å˜ä¸ºçº¢è‰²çŠ¶æ€è¿˜æœ‰å¤šå°‘æ—¶é—´ï¼ˆæˆ–å·²è¶…è¿‡å¤šå°‘ï¼‰</li>
            <li><strong>å·¦é”®çŠ¶æ€å°æ–¹å—</strong>ï¼šè®¾ç½®/ä¿®æ”¹â€œè‹¥å¤šå°‘åˆ†é’Ÿæœªç¼–è¾‘åˆ™å˜çº¢â€çš„è‡ªå®šä¹‰é˜ˆå€¼ï¼ˆå¦‚ 30ï¼‰</li>
            <li><strong>æ‹–åŠ¨ä¸‹æ–¹è¿›åº¦æ¡</strong>å³å¯æ¨ªå‘æ»šåŠ¨è¡¨æ ¼ï¼Œä¸”ä¸ä¼šé®æŒ¡ä»»ä½•å†…å®¹</li>
            <li><strong>åˆ†é¡µ</strong>ï¼šæ¯é¡µæœ€å¤šæ˜¾ç¤º 3 é¡¹ç›®ï¼Œä½¿ç”¨ã€Œ-ã€/ã€Œ+ã€åˆ‡æ¢</li>
            <li><strong>ä¿å­˜æŒ‰é’®</strong>ï¼šç‚¹æ­¤æŠŠå½“å‰æ‰€æœ‰æ–‡å­—ã€çŠ¶æ€ã€å±•å¼€ã€åˆ†é¡µç­‰ä¿¡æ¯ä¿å­˜åˆ°æœ¬åœ°ï¼ˆlocalStorageï¼‰</li>
            <li><strong>ç¼–è¾‘å­ä»»åŠ¡å</strong>ï¼šå¯¹åº”çš„ä¸Šä¸€çº§ï¼ˆä¸»ä»»åŠ¡ï¼‰çŠ¶æ€æŒ‡ç¤ºç¯ä¼šè‡ªåŠ¨é‡ç½®ä¸ºæœ€æ–°æ—¶é—´</li>
            <li><strong>å­ä»»åŠ¡è¡Œå·¦ä¾§ã€Œâ–² | æŠ˜å è¿‡å¾€ã€æŒ‰é’®</strong>ï¼šç‚¹å‡»æŒ‰é’®æœ¬èº«å¯æŠ˜å /å±•å¼€å½“å‰å­ä»»åŠ¡è¡Œï¼›ç‚¹å‡»æŒ‰é’®ä¸Šçš„æ•°å­—å¯æŸ¥çœ‹è¯¥çˆ¶ä»»åŠ¡ä¸­å·²æŠ˜å çš„å­ä»»åŠ¡å†…å®¹</li>
            <li><strong>æŠ˜å å†å²åˆ†é¡µ</strong>ï¼šå½“æŠ˜å çš„å­ä»»åŠ¡è¶…è¿‡30ä¸ªæ—¶ï¼Œä¼šå°†å…¶æŠ˜å ä¸ºâ€œ1*10â€çš„æ ¼å¼ï¼Œç‚¹å‡»æ•°å­—â€œ1â€å¯å±•å¼€æŸ¥çœ‹è¿™10ä¸ªå­ä»»åŠ¡</li>
        </ul>
    </div>

    <div class="table-wrapper">
        <div class="table-container" id="tableContainer">
            <table id="taskTable">
                <thead><tr id="headerRow"></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        <!-- è‡ªå®šä¹‰æ°´å¹³æ»šåŠ¨æ¡ -->
        <div class="scrollbar" id="customScrollbar">
            <div class="track"><div class="thumb" id="scrollThumb"></div></div>
        </div>
    </div>

    <div class="legend">
        <div class="legend-item"><div class="legend-color" style="background:#4CAF50;"></div><span>&lt;12â€¯h</span></div>
        <div class="legend-item"><div class="legend-color" style="background:#FFC107;"></div><span>&lt;24â€¯h</span></div>
        <div class="legend-item"><div class="legend-color" style="background:#F44336;"></div><span>â‰¥24â€¯h</span></div>
    </div>

    <div class="actions">
        <button class="add-task-btn" onclick="addNewTask()">+ æ·»åŠ æ–°ä»»åŠ¡</button>
        <button class="reset-btn" onclick="resetView()">é‡ç½®è§†å›¾</button>
        <button class="save-btn" onclick="saveState()">ğŸ’¾ ä¿å­˜çŠ¶æ€</button>
    </div>

    <!-- åˆ†é¡µæ§åˆ¶ -->
    <div class="pagination">
        <button class="prev-page-btn" onclick="prevPage()">âˆ’</button>
        <span id="pageInfo">ç¬¬ 1 / 1 é¡µ</span>
        <button class="next-page-btn" onclick="nextPage()">+</button>
    </div>
</div>

<script>
/* ---------- å¸¸é‡é˜ˆå€¼ ---------- */
const GREEN_THRESHOLD_MS  = 12 * 60 * 60 * 1000;   // 12h
const YELLOW_THRESHOLD_MS = 24 * 60 * 60 * 1000;   // 24h
const DEFAULT_RED_THRESHOLD_MS = 24 * 60 * 60 * 1000; // é»˜è®¤çº¢è‰²é˜ˆå€¼ 24h

/* -------------------- æ•°æ®æ¨¡å‹ -------------------- */
let tasks = [
    {
        name:"é¡¹ç›®A",
        cells:[
            {
                content:"å®Œæˆéœ€æ±‚åˆ†æ",
                completed:false,
                lastUpdated:new Date(Date.now()-2*60*60*1000),
                expanded:false,
                redThreshold:null,
                subCells:[
                    {content:"è°ƒç ”ç”¨æˆ·åœºæ™¯",completed:false,lastUpdated:new Date(Date.now()-1*60*60*1000),collapsed:true,collapsedAt:new Date(Date.now()-3*60*60*1000),redThreshold:null},
                    {content:"æ•´ç†éœ€æ±‚æ–‡æ¡£",completed:true,lastUpdated:new Date(Date.now()-2*60*60*1000),collapsed:false,redThreshold:null}
                ]
            },
            {
                content:"è®¾è®¡ç³»ç»Ÿæ¶æ„",
                completed:true,
                lastUpdated:new Date(Date.now()-5*60*60*1000),
                expanded:false,
                redThreshold:null,
                subCells:[
                    {content:"ç»˜åˆ¶UMLå›¾",completed:true,lastUpdated:new Date(Date.now()-3*60*60*1000),collapsed:true,collapsedAt:new Date(Date.now()-4*60*60*1000),redThreshold:null},
                    {content:"æŠ€æœ¯é€‰å‹",completed:true,lastUpdated:new Date(Date.now()-3*60*60*1000),collapsed:false,redThreshold:null}
                ]
            }
        ]
    },
    {
        name:"é¡¹ç›®B",
        cells:[
            {
                content:"ç¼–å†™æ ¸å¿ƒæ¨¡å—",
                completed:false,
                lastUpdated:new Date(Date.now()-15*60*60*1000),
                expanded:false,
                redThreshold:null,
                subCells:[
                    {content:"å®ç°APIæ¥å£",completed:false,lastUpdated:new Date(Date.now()-12*60*60*1000),collapsed:true,collapsedAt:new Date(Date.now()-14*60*60*1000),redThreshold:null}
                ]
            },
            {
                content:"å•å…ƒæµ‹è¯•",
                completed:false,
                lastUpdated:new Date(Date.now()-30*60*60*1000),
                expanded:false,
                redThreshold:null,
                subCells:[
                    {content:"Mockæ•°æ®éªŒè¯",completed:false,lastUpdated:new Date(Date.now()-28*60*60*1000),collapsed:false,redThreshold:null}
                ]
            }
        ]
    },
    {
        name:"æ—¥å¸¸ä»»åŠ¡",
        cells:[
            {
                content:"ä»£ç å®¡æŸ¥",
                completed:true,
                lastUpdated:new Date(Date.now()-8*60*60*1000),
                expanded:false,
                redThreshold:null,
                subCells:[
                    {content:"æ£€æŸ¥å®‰å…¨æ¼æ´",completed:true,lastUpdated:new Date(Date.now()-7*60*60*1000),collapsed:false,redThreshold:null}
                ]
            },
            {
                content:"å›¢é˜Ÿä¼šè®®",
                completed:false,
                lastUpdated:new Date(Date.now()-10*60*60*1000),
                expanded:false,
                redThreshold:null,
                subCells:[
                    {content:"åŒæ­¥é¡¹ç›®è¿›åº¦",completed:false,lastUpdated:new Date(Date.now()-9*60*60*1000),collapsed:false,redThreshold:null}
                ]
            }
        ]
    }
];

let expandedColumnIdx = null;   // å½“å‰å±•å¼€çš„ä¸»ä»»åŠ¡åˆ—ï¼ˆè‹¥æœ‰ï¼‰
let expandedCellIdx   = null;   // å¯¹åº”çš„ä¸»ä»»åŠ¡å•å…ƒæ ¼ç´¢å¼•
let currentTaskFilter = null;   // null â†’ æ˜¾ç¤ºå…¨éƒ¨
let currentPage = 0;            // å½“å‰åˆ†é¡µï¼ˆä» 0 å¼€å§‹è®¡æ•°ï¼‰
const tasksPerPage = 3;         // æ¯é¡µæœ€å¤šæ˜¾ç¤ºçš„é¡¹ç›®æ•°

/* ----------- åŒå‡»/å•å‡»è¡¨å¤´çš„è®¡æ—¶å™¨ï¼Œé˜²æ­¢å†²çª ----------- */
let headerClickTimer = null;
const headerClickDelay = 250;   // ms

/* -------------------- åˆå§‹åŒ– -------------------- */
function initTable(){
    loadState();      // è¯»å–æœ¬åœ°ä¿å­˜çš„çŠ¶æ€ï¼ˆå¦‚æœæœ‰ï¼‰
    renderTable();
    updateStatusIndicators();
    setInterval(updateStatusIndicators,30000);   // æ¯ 30â€¯s æ›´æ–°é¢œè‰²
    initCustomScrollbar();                      // ä¸ºæ¨ªå‘æ»šåŠ¨æ¡ç»‘å®šäº‹ä»¶
    updatePaginationInfo();
}
document.addEventListener('DOMContentLoaded',initTable);

/* -------------------- æœ¬åœ°æŒä¹…åŒ– -------------------- */
function saveState(){
    const data = {
        tasks: tasks,
        currentPage,
        expandedColumnIdx,
        expandedCellIdx,
        currentTaskFilter
    };
    localStorage.setItem('taskTrackerData', JSON.stringify(data));
    alert('å·²ä¿å­˜å½“å‰çŠ¶æ€');
}
function loadState(){
    const raw = localStorage.getItem('taskTrackerData');
    if(!raw) return;
    try{
        const obj = JSON.parse(raw);
        obj.tasks.forEach(task=>{
            task.cells.forEach(cell=>{
                cell.lastUpdated = new Date(cell.lastUpdated);
                cell.subCells.forEach(sub=>{
                    sub.lastUpdated = new Date(sub.lastUpdated);
                    if(sub.collapsedAt) sub.collapsedAt = new Date(sub.collapsedAt);
                });
            });
        });
        tasks = obj.tasks;
        currentPage = obj.currentPage || 0;
        expandedColumnIdx = obj.expandedColumnIdx;
        expandedCellIdx   = obj.expandedCellIdx;
        currentTaskFilter = obj.currentTaskFilter;
    }catch(e){
        console.warn('è¯»å–æœ¬åœ°ä¿å­˜æ•°æ®å¤±è´¥ï¼Œå°†ä½¿ç”¨é»˜è®¤æ•°æ®ã€‚',e);
    }
}

/* -------------------- æ¸²æŸ“ -------------------- */
function renderTable(){
    const headerRow = document.getElementById('headerRow');
    const tbody    = document.getElementById('tableBody');
    headerRow.innerHTML = '';
    tbody.innerHTML    = '';

    /* ----- è®¡ç®—å¯è§åˆ—ï¼ˆåˆ†é¡µæˆ–è¿‡æ»¤ï¼‰ ----- */
    let visibleIndices;
    if(currentTaskFilter !== null){
        visibleIndices = [currentTaskFilter];
    }else{
        const start = currentPage * tasksPerPage;
        const end   = start + tasksPerPage;
        visibleIndices = tasks.map((_,i)=>i).slice(start,end);
    }

    /* ----- åˆ—é¡ºåºï¼šä¸»åˆ— +ï¼ˆè‹¥å±•å¼€ï¼‰å­ä»»åŠ¡åˆ— ----- */
    const colOrder = [];
    visibleIndices.forEach(idx=>{
        colOrder.push(idx);                // ä¸»ä»»åŠ¡åˆ—
        if(expandedColumnIdx!==null && expandedColumnIdx===idx){
            colOrder.push(`sub-${idx}`); // å¯¹åº”çš„å­ä»»åŠ¡åˆ—
        }
    });

    /* ----- è¡¨å¤´ï¼ˆå•å‡»è¿‡æ»¤ï¼ŒåŒå‡»ç¼–è¾‘ï¼‰ ----- */
    colOrder.forEach(col=>{
        const th=document.createElement('th');
        if(typeof col==='number'){
            th.textContent = tasks[col].name;

            // å•å‡» â†’ è¿‡æ»¤ï¼ˆæˆ–é‡ç½®ï¼‰
            th.addEventListener('click', e=>{
                if(headerClickTimer) clearTimeout(headerClickTimer);
                headerClickTimer = setTimeout(()=>{
                    if (currentTaskFilter!==null) resetView();
                    else filterTask(col);
                    headerClickTimer = null;
                }, headerClickDelay);
            });

            // åŒå‡» â†’ ç¼–è¾‘åˆ—æ ‡é¢˜
            th.addEventListener('dblclick', e=>{
                if(headerClickTimer){
                    clearTimeout(headerClickTimer);
                    headerClickTimer = null;
                }
                editTaskName(col);
                e.stopPropagation();
            });
        }else{
            th.textContent = tasks[expandedColumnIdx].name + ' å­ä»»åŠ¡';
            th.onclick = resetView;
        }
        headerRow.appendChild(th);
    });

    /* ----- è®¡ç®—ä¸»ä»»åŠ¡æœ€å¤§è¡Œæ•° ----- */
    let maxMainRows = 0;
    visibleIndices.forEach(i=> maxMainRows = Math.max(maxMainRows, tasks[i].cells.length));

    /* ----- æŒ‰è¡Œæ¸²æŸ“ï¼šä¸»ä»»åŠ¡è¡Œ â†’ï¼ˆè‹¥å±•å¼€ï¼‰å­ä»»åŠ¡è¡Œ ----- */
    for(let mainRowIdx=0; mainRowIdx<maxMainRows; mainRowIdx++){
        /* ä¸»ä»»åŠ¡è¡Œ */
        const trMain=document.createElement('tr');
        colOrder.forEach(col=>{
            let td;
            if(typeof col==='number'){
                const task = tasks[col];
                const cell = task.cells[mainRowIdx];
                td = cell ? createMainTaskCell(cell,col,mainRowIdx)
                         : (function(){ const d=document.createElement('td'); d.className='empty-cell'; return d; })();
            }else{
                td = document.createElement('td');
                td.className='empty-cell';
            }
            trMain.appendChild(td);
        });
        tbody.appendChild(trMain);

        /* å­ä»»åŠ¡è¡Œï¼ˆä»…åœ¨å±•å¼€åˆ—å¯¹åº”ä¸”è¯¥å•å…ƒæ ¼å·²å±•å¼€æ—¶å‡ºç°ï¼‰ */
        if(expandedColumnIdx!==null && visibleIndices.includes(expandedColumnIdx)){
            const expTask = tasks[expandedColumnIdx];
            const expCell = expTask.cells[mainRowIdx];
            if(expCell && expCell.expanded && expCell.subCells.length>0){
                expCell.subCells.forEach((subCell,subIdx)=>{
                    const trSub=document.createElement('tr');
                    trSub.className = 'sub-row';
                    colOrder.forEach(col=>{
                        let td;
                        if(typeof col==='number'){
                            td = document.createElement('td');
                            td.className='empty-cell';
                        }else{
                            td = createSubTaskCell(subCell,expandedColumnIdx,mainRowIdx,subIdx);
                        }
                        trSub.appendChild(td);
                    });
                    tbody.appendChild(trSub);
                });
            }
        }
    }

    updateScrollbar();          // åŒæ­¥è‡ªå®šä¹‰æ»šåŠ¨æ¡å°ºå¯¸/ä½ç½®
    updatePaginationInfo();     // åŒæ­¥åˆ†é¡µæŒ‰é’®çŠ¶æ€
}

/* -------------------- ä¸»ä»»åŠ¡å•å…ƒæ ¼ï¼ˆå¯ç¼–è¾‘ï¼‰ -------------------- */
function createMainTaskCell(cell,taskIdx,cellIdx){
    const td=document.createElement('td');
    td.className='task-cell';

    /* å¤é€‰æ¡† */
    const cbDiv=document.createElement('div');
    cbDiv.className='checkbox-container';
    const cb=document.createElement('input');
    cb.type='checkbox';
    cb.className='task-checkbox';
    cb.checked=cell.completed;
    cb.onchange=()=>toggleCompleted(taskIdx,cellIdx);
    cbDiv.appendChild(cb);
    td.appendChild(cbDiv);

    /* çŠ¶æ€æŒ‡ç¤ºç¯ï¼ˆå·¦é”®è‡ªå®šä¹‰é˜ˆå€¼ã€å³é”®æŸ¥çœ‹å‰©ä½™æ—¶é—´ï¼‰ */
    const status=document.createElement('div');
    status.className='status-indicator';
    status.id=`status-${taskIdx}-${cellIdx}`;

    // å·¦é”® â†’ è®¾ç½®è‡ªå®šä¹‰çº¢è‰²é˜ˆå€¼ï¼ˆåˆ†é’Ÿï¼‰
    status.addEventListener('click', e=>{
        e.stopPropagation();
        const currentMin = cell.redThreshold ? Math.round(cell.redThreshold/60000) : '';
        const input = prompt('è¯·è¾“å…¥çº¢è‰²æé†’é˜ˆå€¼ï¼ˆåˆ†é’Ÿï¼‰ã€‚ç•™ç©ºæˆ–å–æ¶ˆä½¿ç”¨é»˜è®¤ 24â€¯hï¼š', currentMin);
        if(input===null) return;               // å–æ¶ˆ
        const mins = parseInt(input.trim(),10);
        if(isNaN(mins) || mins<=0){
            cell.redThreshold = null;           // æ¢å¤é»˜è®¤
        }else{
            cell.redThreshold = mins*60*1000;   // ä¿å­˜ä¸ºæ¯«ç§’
        }
        updateStatusIndicators();
    });

    // å³é”® â†’ æŸ¥çœ‹è·ç¦»/å·²è¶…è¿‡é˜ˆå€¼çš„æ—¶é—´
    status.addEventListener('contextmenu', e=>{
        e.preventDefault();
        alert(getStatusTimeInfo(cell));
    });
    td.appendChild(status);

    /* æ§åˆ¶æŒ‰é’®ï¼ˆå±•å¼€ / æ·»åŠ  / åˆ é™¤ï¼‰ */
    const ctrl=document.createElement('div');
    ctrl.className='cell-controls';

    // å±•å¼€/æ”¶èµ·æŒ‡ç¤ºå™¨
    const expand=document.createElement('div');
    expand.className='expand-indicator';
    expand.textContent=cell.expanded?'â–²':'â–¼';
    expand.title=cell.expanded?'æ”¶èµ·å­ä»»åŠ¡':'å±•å¼€å­ä»»åŠ¡';
    expand.onclick=e=>{ e.stopPropagation(); toggleSubCells(taskIdx,cellIdx); };
    ctrl.appendChild(expand);

    // æ·»åŠ æŒ‰é’®
    const addBtn=document.createElement('button');
    addBtn.className='add-cell-btn';
    addBtn.textContent='+';
    addBtn.onclick=e=>{ e.stopPropagation(); addCellBelow(taskIdx,cellIdx); };
    ctrl.appendChild(addBtn);

    // åˆ é™¤æŒ‰é’®
    const delBtn=document.createElement('button');
    delBtn.className='delete-cell-btn';
    delBtn.textContent='Ã—';
    delBtn.onclick=e=>{ e.stopPropagation(); if(confirm('ç¡®å®šè¦åˆ é™¤æ­¤ä»»åŠ¡å•å…ƒæ ¼å—ï¼Ÿ')) deleteCell(taskIdx,cellIdx); };
    ctrl.appendChild(delBtn);
    td.appendChild(ctrl);

    /* å†…å®¹ï¼ˆcontenteditableï¼‰ */
    const contentDiv=document.createElement('div');
    contentDiv.className='cell-content';
    const editable=document.createElement('div');
    editable.className='cell-input';
    editable.contentEditable='true';
    editable.innerText = cell.content;
    editable.title='ç›´æ¥ç¼–è¾‘ï¼Œå›è½¦æ¢è¡Œï¼Œå¤±ç„¦è‡ªåŠ¨ä¿å­˜';
    const save=()=>{
        const v=editable.innerText.trimEnd();
        if(v!==''){
            cell.content=v;
            cell.lastUpdated=new Date();
        }else{
            editable.innerText = cell.content;
        }
        updateStatusIndicators();
    };
    editable.addEventListener('blur',save);
    contentDiv.appendChild(editable);
    td.appendChild(contentDiv);

    return td;
}

/* -------------------- å­ä»»åŠ¡å•å…ƒæ ¼ï¼ˆå¯ç¼–è¾‘ï¼‰ -------------------- */
function createSubTaskCell(subCell,taskIdx,parentCellIdx,subIdx){
    const td=document.createElement('td');
    td.className='sub-task-cell';
    if(subCell.collapsed) td.classList.add('collapsed');

    /* å¤é€‰æ¡† */
    const cbDiv=document.createElement('div');
    cbDiv.className='checkbox-container';
    const cb=document.createElement('input');
    cb.type='checkbox';
    cb.className='task-checkbox';
    cb.checked=subCell.completed;
    cb.onchange=()=>toggleSubCompleted(taskIdx,parentCellIdx,subIdx);
    cbDiv.appendChild(cb);
    td.appendChild(cbDiv);

    /* çŠ¶æ€æŒ‡ç¤ºç¯ï¼ˆå·¦é”®è‡ªå®šä¹‰é˜ˆå€¼ã€å³é”®æŸ¥çœ‹å‰©ä½™æ—¶é—´ï¼‰ */
    const status=document.createElement('div');
    status.className='status-indicator';
    status.id=`status-${taskIdx}-${parentCellIdx}-sub${subIdx}`;

    status.addEventListener('click', e=>{
        e.stopPropagation();
        const currentMin = subCell.redThreshold ? Math.round(subCell.redThreshold/60000) : '';
        const input = prompt('è¯·è¾“å…¥çº¢è‰²æé†’é˜ˆå€¼ï¼ˆåˆ†é’Ÿï¼‰ã€‚ç•™ç©ºæˆ–å–æ¶ˆä½¿ç”¨é»˜è®¤ 24â€¯hï¼š', currentMin);
        if(input===null) return;
        const mins = parseInt(input.trim(),10);
        if(isNaN(mins) || mins<=0){
            subCell.redThreshold = null;
        }else{
            subCell.redThreshold = mins*60*1000;
        }
        updateStatusIndicators();
    });

    status.addEventListener('contextmenu', e=>{
        e.preventDefault();
        alert(getStatusTimeInfo(subCell));
    });
    td.appendChild(status);

    /* ----- å·¦ä¾§æ§åˆ¶ï¼šæŠ˜å /å±•å¼€æŒ‰é’® + æŠ˜å å†å²æŒ‰é’®ï¼ˆæ¨ªå‘å¹¶æ’ï¼‰ ----- */
    const leftControls=document.createElement('div');
    leftControls.className='sub-left-controls';

    // 1ï¸âƒ£ æŠ˜å /å±•å¼€æŒ‰é’®
    const toggleBtn=document.createElement('div');
    toggleBtn.className='expand-indicator';
    toggleBtn.textContent = subCell.collapsed ? 'â–¼' : 'â–²';
    toggleBtn.title = subCell.collapsed ? 'å±•å¼€æ­¤å­ä»»åŠ¡' : 'æŠ˜å æ­¤å­ä»»åŠ¡';
    toggleBtn.onclick = function(e){
        e.stopPropagation();
        toggleSubRowCollapse(taskIdx,parentCellIdx,subIdx);
    };
    leftControls.appendChild(toggleBtn);

    // 2ï¸âƒ£ æŠ˜å å†å²æŒ‰é’®ï¼ˆæ˜¾ç¤ºå·²æŠ˜å å­ä»»åŠ¡æ•°é‡ï¼‰
    const parentCell = tasks[taskIdx].cells[parentCellIdx];
    const collapsedCount = parentCell.subCells.filter(s => s.collapsed).length;
    const historyBtn=document.createElement('button');
    historyBtn.className='sub-history-btn';
    if(collapsedCount > 30){
        const groupCount = Math.ceil(collapsedCount / 10);
        const lastGroupCount = collapsedCount % 10 === 0 ? 10 : collapsedCount % 10;
        historyBtn.innerHTML = `æŠ˜å è¿‡å¾€ <span class="count">${groupCount}*${lastGroupCount}</span>`;
    }else{
        historyBtn.innerHTML = `æŠ˜å è¿‡å¾€ <span class="count">${collapsedCount}</span>`;
    }
    historyBtn.title = `å·²æŠ˜å  ${collapsedCount} é¡¹å­ä»»åŠ¡`;
    historyBtn.onclick = function(e){
        e.stopPropagation();
        showCollapsedHistory(taskIdx,parentCellIdx);
    };
    leftControls.appendChild(historyBtn);

    td.appendChild(leftControls);
    /* ------------------------------------------------------- */

    /* æ§åˆ¶æŒ‰é’®ï¼ˆæ·»åŠ  / åˆ é™¤ï¼‰ */
    const ctrl=document.createElement('div');
    ctrl.className='cell-controls';

    const addBtn=document.createElement('button');
    addBtn.className='add-cell-btn';
    addBtn.textContent='+';
    addBtn.onclick=e=>{ e.stopPropagation(); addSubCellBelow(taskIdx,parentCellIdx,subIdx); };
    ctrl.appendChild(addBtn);

    const delBtn=document.createElement('button');
    delBtn.className='delete-cell-btn';
    delBtn.textContent='Ã—';
    delBtn.onclick=e=>{ e.stopPropagation(); if(confirm('ç¡®å®šè¦åˆ é™¤æ­¤å­ä»»åŠ¡å—ï¼Ÿ')) deleteSubCell(taskIdx,parentCellIdx,subIdx); };
    ctrl.appendChild(delBtn);
    td.appendChild(ctrl);

    /* å†…å®¹ï¼ˆcontenteditableï¼‰ */
    const contentDiv=document.createElement('div');
    contentDiv.className='sub-cell-content';
    const editable=document.createElement('div');
    editable.className='sub-cell-input';
    editable.contentEditable='true';
    editable.innerText=subCell.content;
    editable.title='ç›´æ¥ç¼–è¾‘ï¼Œå›è½¦æ¢è¡Œï¼Œå¤±ç„¦è‡ªåŠ¨ä¿å­˜';
    const save=()=>{
        const v=editable.innerText.trimEnd();
        if(v!==''){
            subCell.content=v;
            subCell.lastUpdated=new Date();   // å­ä»»åŠ¡è‡ªèº«æ›´æ–°æ—¶é—´
            // åŒæ­¥çˆ¶ä»»åŠ¡çš„ lastUpdatedï¼ˆçŠ¶æ€ç¯é‡ç½®ï¼‰
            const parent = tasks[taskIdx].cells[parentCellIdx];
            parent.lastUpdated = new Date();
        }else{
            editable.innerText=subCell.content;
        }
        updateStatusIndicators();
    };
    editable.addEventListener('blur',save);
    contentDiv.appendChild(editable);
    td.appendChild(contentDiv);

    return td;
}

/* -------------------- äº¤äº’å‡½æ•° -------------------- */
function toggleCompleted(ti,ci){
    const cell=tasks[ti].cells[ci];
    cell.completed=!cell.completed;
    renderTable();
    updateStatusIndicators();
}
function toggleSubCompleted(ti,pi,si){
    const sub=tasks[ti].cells[pi].subCells[si];
    sub.completed=!sub.completed;
    // åŒæ­¥çˆ¶ä»»åŠ¡çš„ lastUpdated
    tasks[ti].cells[pi].lastUpdated = new Date();
    renderTable();
    updateStatusIndicators();
}
function addCellBelow(ti,ci){
    const newCell={content:'æ–°ä»»åŠ¡',completed:false,lastUpdated:new Date(),expanded:false,redThreshold:null,subCells:[]};
    tasks[ti].cells.splice(ci+1,0,newCell);
    renderTable();
    updateStatusIndicators();
}
function addSubCellBelow(ti,pi,si){
    const newSub={content:'æ–°å­ä»»åŠ¡',completed:false,lastUpdated:new Date(),collapsed:false,redThreshold:null};
    tasks[ti].cells[pi].subCells.splice(si+1,0,newSub);
    // åŒæ­¥çˆ¶ä»»åŠ¡çš„ lastUpdated
    tasks[ti].cells[pi].lastUpdated = new Date();
    renderTable();
    updateStatusIndicators();
}
function deleteCell(ti,ci){
    tasks[ti].cells.splice(ci,1);
    if(expandedColumnIdx===ti && expandedCellIdx===ci){
        expandedColumnIdx=null;
        expandedCellIdx=null;
    }
    renderTable();
    updateStatusIndicators();
}

/* ---------- åˆ é™¤å­ä»»åŠ¡ ----------
   å½“åˆ é™¤åå¦‚æœçˆ¶ä»»åŠ¡å·²ç»æ²¡æœ‰å­ä»»åŠ¡ï¼Œåˆ™è‡ªåŠ¨æ”¶èµ·å­ä»»åŠ¡åˆ—
   è¿™æ ·å°±å¯ä»¥çœŸæ­£æŠŠâ€œå”¯ä¸€çš„å­ä»»åŠ¡â€åˆ æ‰ï¼Œè€Œä¸ä¼šç•™ä¸‹ç©ºçš„å­ä»»åŠ¡åˆ— */
function deleteSubCell(ti,pi,si){
    const parentCell = tasks[ti].cells[pi];

    // 1ï¸âƒ£ åˆ é™¤ç›®æ ‡å­ä»»åŠ¡
    parentCell.subCells.splice(si, 1);

    // 2ï¸âƒ£ æ›´æ–°çˆ¶ä»»åŠ¡çš„æ—¶é—´æˆ³ï¼ˆçŠ¶æ€ç¯ä¼šéšä¹‹åˆ·æ–°ï¼‰
    parentCell.lastUpdated = new Date();

    // 3ï¸âƒ£ å¦‚æœå·²æ²¡æœ‰ä»»ä½•å­ä»»åŠ¡ï¼Œåˆ™è‡ªåŠ¨æ”¶èµ·è¯¥åˆ—
    if (parentCell.subCells.length === 0) {
        parentCell.expanded = false;
        if (expandedColumnIdx === ti && expandedCellIdx === pi) {
            expandedColumnIdx = null;
            expandedCellIdx   = null;
        }
    }

    renderTable();
    updateStatusIndicators();
}

/* å±•å¼€/æ”¶èµ·å­ä»»åŠ¡åˆ—ï¼ˆåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªå­ä»»åŠ¡åˆ—ï¼‰ */
function toggleSubCells(ti,ci){
    const cell=tasks[ti].cells[ci];
    const willExpand=!cell.expanded;

    // å…³é—­ä¸Šä¸€æ¬¡å±•å¼€çš„åˆ—ï¼ˆè‹¥ä¸æ˜¯åŒä¸€ä¸ªå•å…ƒæ ¼ï¼‰
    if(expandedColumnIdx!==null && (expandedColumnIdx!==ti || expandedCellIdx!==ci)){
        const prevCell=tasks[expandedColumnIdx].cells[expandedCellIdx];
        if(prevCell) prevCell.expanded=false;
        expandedColumnIdx=null;
        expandedCellIdx=null;
    }

    if(willExpand){
        if(cell.subCells.length===0){
            cell.subCells.push({content:'å­ä»»åŠ¡',completed:false,lastUpdated:new Date(),collapsed:false,redThreshold:null});
        }
        cell.expanded=true;
        expandedColumnIdx=ti;
        expandedCellIdx=ci;
    }else{
        cell.expanded=false;
        expandedColumnIdx=null;
        expandedCellIdx=null;
    }
    renderTable();
    updateStatusIndicators();
}

/* ---------- æŠ˜å /å±•å¼€å•ä¸ªå­ä»»åŠ¡è¡Œï¼ˆä»…æœ¬è¡Œï¼‰---------- */
function toggleSubRowCollapse(ti, pi, si){
    const sub = tasks[ti].cells[pi].subCells[si];
    sub.collapsed = !sub.collapsed;
    sub.collapsedAt = sub.collapsed ? new Date() : null;   // è®°å½•/æ¸…é™¤æŠ˜å æ—¶é—´
    renderTable();   // ç›´æ¥é‡æ–°æ¸²æŸ“ï¼ŒçŠ¶æ€ã€è®¡æ•°ç­‰ä¼šè‡ªåŠ¨æ›´æ–°
}

/* ---------- æ˜¾ç¤ºå·²æŠ˜å çš„å­ä»»åŠ¡å†å² ---------- */
function showCollapsedHistory(taskIdx, parentCellIdx) {
    const parentCell = tasks[taskIdx].cells[parentCellIdx];
    const collapsedSubs = parentCell.subCells.filter(s => s.collapsed);

    if (collapsedSubs.length === 0) {
        alert('è¯¥çˆ¶ä»»åŠ¡ä¸‹æš‚æ— å·²æŠ˜å çš„å­ä»»åŠ¡');
        return;
    }

    // åˆ›å»ºæµ®å±‚
    const popover = document.createElement('div');
    popover.className = 'history-popover';
    popover.innerHTML = '<strong>å·²æŠ˜å çš„å­ä»»åŠ¡ï¼š</strong>';

    // è¶…è¿‡ 30 æ¡æ—¶åˆ†ç»„æ˜¾ç¤ºï¼ˆæ¯ 10 æ¡ä¸ºä¸€ç»„ï¼‰
    if (collapsedSubs.length > 30) {
        const groups = [];
        for (let i = 0; i < collapsedSubs.length; i += 10) {
            groups.push(collapsedSubs.slice(i, i + 10));
        }

        groups.forEach((group, groupIndex) => {
            const groupItem = document.createElement('div');
            groupItem.className = 'history-item';

            const groupContent = document.createElement('div');
            groupContent.className = 'history-content';
            groupContent.textContent = `ç¬¬ ${groupIndex + 1} ç»„ (${group.length} æ¡)`;

            const expandGroupBtn = document.createElement('div');
            expandGroupBtn.className = 'restore-btn';
            expandGroupBtn.textContent = 'â–¼';
            expandGroupBtn.title = 'ç‚¹å‡»å±•å¼€æ­¤ç»„';
            expandGroupBtn.onclick = function(e) {
                e.stopPropagation();
                popover.remove();
                showCollapsedGroup(group, groupIndex + 1);
            };

            groupItem.appendChild(groupContent);
            groupItem.appendChild(expandGroupBtn);
            popover.appendChild(groupItem);
        });
    } else {
        // ä¸éœ€è¦åˆ†ç»„ï¼Œç›´æ¥åˆ—å‡ºæ‰€æœ‰å·²æŠ˜å çš„å­ä»»åŠ¡
        collapsedSubs.forEach(sub => {
            const item = document.createElement('div');
            item.className = 'history-item';

            const content = document.createElement('div');
            content.className = 'history-content';
            content.textContent = sub.content.length > 30 ? sub.content.substring(0,30)+'...' : sub.content;

            const time = document.createElement('div');
            time.className = 'history-time';
            time.textContent = `æŠ˜å äºï¼š${formatTimeDifference(sub.collapsedAt||sub.lastUpdated)}`;

            const restoreBtn = document.createElement('div');
            restoreBtn.className = 'restore-btn';
            restoreBtn.textContent = 'â–²';
            restoreBtn.title = 'ç‚¹å‡»æ¢å¤æ­¤å­ä»»åŠ¡';
            restoreBtn.onclick = () => {
                sub.collapsed = false;
                sub.collapsedAt = null;
                renderTable();
                popover.remove();
            };

            item.appendChild(content);
            item.appendChild(time);
            item.appendChild(restoreBtn);
            popover.appendChild(item);
        });
    }

    document.body.appendChild(popover);
    const rect = event.target.getBoundingClientRect();
    popover.style.top = `${rect.bottom + window.scrollY}px`;
    popover.style.left = `${rect.left + window.scrollX}px`;

    const close = () => {
        if (popover.parentNode) popover.parentNode.removeChild(popover);
        document.removeEventListener('click', close);
    };
    setTimeout(() => document.addEventListener('click', close), 10);
}

/* ---------- æ˜¾ç¤ºå·²æŠ˜å çš„å­ä»»åŠ¡å†å²ï¼ˆç»„ï¼‰ ---------- */
function showCollapsedGroup(group, groupNumber) {
    const popover = document.createElement('div');
    popover.className = 'history-popover';
    popover.innerHTML = `<strong>ç¬¬ ${groupNumber} ç»„ï¼š</strong>`;

    group.forEach(sub => {
        const item = document.createElement('div');
        item.className = 'history-item';

        const content = document.createElement('div');
        content.className = 'history-content';
        content.textContent = sub.content.length > 30 ? sub.content.substring(0,30)+'...' : sub.content;

        const time = document.createElement('div');
        time.className = 'history-time';
        time.textContent = `æŠ˜å äºï¼š${formatTimeDifference(sub.collapsedAt||sub.lastUpdated)}`;

        const restoreBtn = document.createElement('div');
        restoreBtn.className = 'restore-btn';
        restoreBtn.textContent = 'â–²';
        restoreBtn.title = 'ç‚¹å‡»æ¢å¤æ­¤å­ä»»åŠ¡';
        restoreBtn.onclick = () => {
            sub.collapsed = false;
            sub.collapsedAt = null;
            renderTable();
            popover.remove();
        };

        item.appendChild(content);
        item.appendChild(time);
        item.appendChild(restoreBtn);
        popover.appendChild(item);
    });

    document.body.appendChild(popover);
    const rect = event.target.getBoundingClientRect();
    popover.style.top = `${rect.bottom + window.scrollY}px`;
    popover.style.left = `${rect.left + window.scrollX}px`;

    const close = () => {
        if (popover.parentNode) popover.parentNode.removeChild(popover);
        document.removeEventListener('click', close);
    };
    setTimeout(() => document.addEventListener('click', close), 10);
}

/* ---------- è¿‡æ»¤è§†å›¾ ---------- */
function filterTask(idx){
    currentTaskFilter=idx;
    renderTable();
}
function resetView(){
    currentTaskFilter=null;
    renderTable();
}

/* ---------- æ·»åŠ æ–°ä»»åŠ¡ï¼ˆæ–°åˆ—ï¼‰ ---------- */
function addNewTask(){
    const name=prompt('è¾“å…¥æ–°ä»»åŠ¡åç§°:');
    if(name && name.trim()){
        tasks.push({
            name:name.trim(),
            cells:[{content:'æ–°ä»»åŠ¡é¡¹',completed:false,lastUpdated:new Date(),expanded:false,redThreshold:null,subCells:[]}]
        });
        renderTable();
        updateStatusIndicators();
    }
}

/* ---------- åŒå‡»ç¼–è¾‘åˆ—æ ‡é¢˜ ---------- */
function editTaskName(idx){
    const cur = tasks[idx].name;
    const newName = prompt('ç¼–è¾‘ä»»åŠ¡åç§°ï¼ˆåˆ—æ ‡é¢˜ï¼‰:', cur);
    if(newName!==null && newName.trim()!==''){
        tasks[idx].name = newName.trim();
        renderTable();
    }
}

/* ---------- çŠ¶æ€æŒ‡ç¤ºç¯é¢œè‰²æ›´æ–° ---------- */
function updateStatusIndicators(){
    const now=Date.now();
    tasks.forEach((task,tIdx)=>{
        task.cells.forEach((cell,cIdx)=>{
            const st=document.getElementById(`status-${tIdx}-${cIdx}`);
            if(st){
                if(cell.completed){
                    st.className='status-indicator status-green';
                }else{
                    const redTh = cell.redThreshold ?? DEFAULT_RED_THRESHOLD_MS;
                    const diff = now - cell.lastUpdated.getTime();
                    if(diff >= redTh){
                        st.className='status-indicator status-red';
                    }else if(diff < GREEN_THRESHOLD_MS){
                        st.className='status-indicator status-green';
                    }else if(diff < YELLOW_THRESHOLD_MS){
                        st.className='status-indicator status-yellow';
                    }else{
                        // åœ¨é»„é˜ˆå€¼å’Œè‡ªå®šä¹‰çº¢é˜ˆå€¼ä¹‹é—´ï¼Œä»æ˜¾ç¤ºé»„è‰²
                        st.className='status-indicator status-yellow';
                    }
                }
            }
            cell.subCells.forEach((sub,sIdx)=>{
                const sst=document.getElementById(`status-${tIdx}-${cIdx}-sub${sIdx}`);
                if(sst){
                    if(sub.completed){
                        sst.className='status-indicator status-green';
                    }else{
                        const redTh = sub.redThreshold ?? DEFAULT_RED_THRESHOLD_MS;
                        const diff = now - sub.lastUpdated.getTime();
                        if(diff >= redTh){
                            sst.className='status-indicator status-red';
                        }else if(diff < GREEN_THRESHOLD_MS){
                            sst.className='status-indicator status-green';
                        }else if(diff < YELLOW_THRESHOLD_MS){
                            sst.className='status-indicator status-yellow';
                        }else{
                            sst.className='status-indicator status-yellow';
                        }
                    }
                }
            });
        });
    });
}

/* ---------- è®¡ç®— â€œè·ç¦»çº¢è‰²çŠ¶æ€è¿˜æœ‰/å·²è¶…è¿‡å¤šå°‘æ—¶é—´â€ ---------- */
function getStatusTimeInfo(cell){
    const now = Date.now();
    const elapsedMs = now - new Date(cell.lastUpdated).getTime();
    const redTh = cell.redThreshold ?? DEFAULT_RED_THRESHOLD_MS;
    if (elapsedMs >= redTh){
        const overMs = elapsedMs - redTh;
        const h = Math.floor(overMs / (1000*60*60));
        const m = Math.round((overMs % (1000*60*60)) / (1000*60));
        return `å·²è¶…è¿‡çº¢è‰²çŠ¶æ€ ${h} å°æ—¶ ${m} åˆ†é’Ÿ`;
    }else{
        const remainMs = redTh - elapsedMs;
        const h = Math.floor(remainMs / (1000*60*60));
        const m = Math.round((remainMs % (1000*60*60)) / (1000*60));
        return `è·ç¦»çº¢è‰²çŠ¶æ€è¿˜æœ‰ ${h} å°æ—¶ ${m} åˆ†é’Ÿ`;
    }
}

/* ---------- æ—¶é—´å·®æ ¼å¼åŒ–ï¼ˆç”¨äºæŠ˜å å†å²ï¼‰ ---------- */
function formatTimeDifference(date) {
    const now = Date.now();
    const diffMs = now - date.getTime();
    const diffSecs = Math.floor(diffMs / 1000);
    const diffMins = Math.floor(diffSecs / 60);
    const diffHrs = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHrs / 24);

    if (diffDays > 0) {
        return `${diffDays}å¤©å‰`;
    } else if (diffHrs > 0) {
        return `${diffHrs}å°æ—¶å‰`;
    } else if (diffMins > 0) {
        return `${diffMins}åˆ†é’Ÿå‰`;
    } else {
        return 'åˆšåˆš';
    }
}

/* -------------------- è‡ªå®šä¹‰æ¨ªå‘æ»šåŠ¨æ¡ -------------------- */
function initCustomScrollbar(){
    const thumb=document.getElementById('scrollThumb');
    const track=document.querySelector('#customScrollbar .track');
    const container=document.getElementById('tableContainer');

    let isDragging=false;
    let startX=0;
    let startLeft=0;

    // æ‹–åŠ¨ thumb
    thumb.addEventListener('mousedown',e=>{
        e.preventDefault();
        isDragging=true;
        startX=e.pageX;
        const m=thumb.style.transform.match(/translateX\(([^)]+)px\)/);
        startLeft=m?parseFloat(m[1]):0;
        document.body.classList.add('no-select');
    });
    document.addEventListener('mousemove',e=>{
        if(!isDragging) return;
        const dx=e.pageX-startX;
        const trackWidth=track.clientWidth;
        const maxThumbLeft=trackWidth-thumb.offsetWidth;
        let newLeft=startLeft+dx;
        newLeft=Math.max(0,Math.min(newLeft,maxThumbLeft));
        thumb.style.transform=`translateX(${newLeft}px)`;

        // åŒæ­¥å®¹å™¨æ»šåŠ¨
        const maxScroll=container.scrollWidth-container.clientWidth;
        const scrollLeft=(newLeft/maxThumbLeft)*maxScroll;
        container.scrollLeft=scrollLeft;
    });
    document.addEventListener('mouseup',()=>{
        if(isDragging){
            isDragging=false;
            document.body.classList.remove('no-select');
        }
    });

    // ç‚¹å‡»è½¨é“è·³è½¬
    track.addEventListener('click',e=>{
        if(isDragging) return;
        const rect=track.getBoundingClientRect();
        const clickX=e.clientX-rect.left;
        const thumbWidth=thumb.offsetWidth;
        const trackWidth=track.clientWidth;
        const maxThumbLeft=trackWidth-thumbWidth;
        let newLeft=clickX-thumbWidth/2;
        newLeft=Math.max(0,Math.min(newLeft,maxThumbLeft));
        thumb.style.transform=`translateX(${newLeft}px)`;
        const maxScroll=container.scrollWidth-container.clientWidth;
        const scrollLeft=(newLeft/maxThumbLeft)*maxScroll;
        container.scrollLeft=scrollLeft;
    });
}

/* æ ¹æ®å®¹å™¨æ»šåŠ¨åŒæ­¥ thumb å¤§å°/ä½ç½® */
function updateScrollbar(){
    const container=document.getElementById('tableContainer');
    const thumb=document.getElementById('scrollThumb');
    const track=document.querySelector('#customScrollbar .track');

    const scrollWidth=container.scrollWidth;
    const clientWidth=container.clientWidth;

    if(scrollWidth<=clientWidth){
        thumb.style.display='none';
        return;
    }else{
        thumb.style.display='block';
    }

    const ratio=clientWidth/scrollWidth;
    const thumbWidth=Math.max(ratio*track.clientWidth,30);
    thumb.style.width=thumbWidth+'px';

    const maxScroll=scrollWidth-clientWidth;
    const maxThumbLeft=track.clientWidth-thumbWidth;
    const left=(container.scrollLeft/maxScroll)*maxThumbLeft;
    thumb.style.transform=`translateX(${left}px)`;
}

/* -------------------- åˆ†é¡µæ§åˆ¶ -------------------- */
function nextPage(){
    if(currentTaskFilter!==null) return;
    const totalPages=Math.ceil(tasks.length/tasksPerPage);
    if(currentPage<totalPages-1){
        currentPage++;
        expandedColumnIdx=null;
        expandedCellIdx=null;
        renderTable();
    }
}
function prevPage(){
    if(currentTaskFilter!==null) return;
    if(currentPage>0){
        currentPage--;
        expandedColumnIdx=null;
        expandedCellIdx=null;
        renderTable();
    }
}
function updatePaginationInfo(){
    const pageInfo=document.getElementById('pageInfo');
    const totalPages=Math.ceil(tasks.length/tasksPerPage);
    pageInfo.textContent=`ç¬¬ ${currentPage+1} / ${totalPages} é¡µ`;

    const prevBtn=document.querySelector('.prev-page-btn');
    const nextBtn=document.querySelector('.next-page-btn');
    if(currentTaskFilter!==null){
        prevBtn.disabled=true;
        nextBtn.disabled=true;
    }else{
        prevBtn.disabled = currentPage===0;
        nextBtn.disabled = currentPage>=totalPages-1;
    }
}

/* -------------------- ç»“æŸ -------------------- */
</script>
</body>
</html>
