<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ä»»åŠ¡è¿½è¸ªè¡¨æ ¼ï¼ˆåˆ†é¡µ + å¯ç¼–è¾‘ + è‡ªå®šä¹‰æ¨ªå‘æ»šåŠ¨æ¡ï¼‰</title>
<style>
    *{
        box-sizing:border-box;
        margin:0;
        padding:0;
        font-family:"Segoe UI","Microsoft YaHei",sans-serif;
    }
    body{
        background:#121212;
        padding:20px;
        color:#e0e0e0;
    }
    .container{
        max-width:1200px;
        margin:auto;
    }
    h1{
        text-align:center;
        margin-bottom:20px;
        font-size:28px;
    }
    .instructions{
        background:#1e1e1e;
        padding:15px;
        border-radius:8px;
        margin-bottom:20px;
        border-left:4px solid #2196f3;
    }
    .instructions h2{margin-bottom:10px;color:#4fc3f7;}
    .instructions li{margin-bottom:8px;color:#bbbbbb;}
    .table-wrapper{
        position:relative;
        margin-bottom:20px;
    }
    .table-container{
        overflow-x:auto;
        background:#1e1e1e;
        border-radius:10px;
        box-shadow:0 4px 12px rgba(0,0,0,.5);
        padding:20px;
    }
    table{
        width:100%;
        border-collapse:collapse;
        min-width:800px;
    }
    th{
        background:#2c3e50;
        color:#fff;
        padding:15px 10px;
        text-align:center;
        cursor:pointer;
        transition:bg .3s;
        border-bottom:1px solid #333;
    }
    th:hover{background:#34495e;}
    .task-cell{
        border:1px solid #333;
        padding:12px;
        position:relative;
        background:#2b2b2b;
        transition:bg .2s;
    }
    .task-cell:hover{background:#333;}
    .sub-task-cell{
        border:1px solid #444;
        padding:12px;
        position:relative;
        background:#333;
        transition:bg .2s;
    }
    .sub-task-cell:hover{background:#3a3a3a;}
    .status-indicator{
        position:absolute;
        top:8px;
        right:8px;
        width:16px;
        height:16px;
        border-radius:3px;
        z-index:2;
    }
    .status-green{background:#4CAF50;}
    .status-yellow{background:#FFC107;}
    .status-red{background:#F44336;}
    .cell-controls{
        position:absolute;
        top:30px;
        right:8px;
        display:flex;
        gap:4px;
        z-index:3;
    }
    .add-cell-btn,.delete-cell-btn{
        width:24px;height:24px;
        border:none;
        display:flex;
        align-items:center;
        justify-content:center;
        cursor:pointer;
        font-weight:bold;
        font-size:14px;
        transition:all .2s;
    }
    .add-cell-btn{
        background:#4CAF50;color:#fff;
    }
    .add-cell-btn:hover{background:#388E3C;}
    .delete-cell-btn{
        background:#F44318;color:#fff;
    }
    .delete-cell-btn:hover{background:#D32F2F;}
    .checkbox-container{
        position:absolute;
        top:8px;
        left:8px;
        z-index:2;
    }
    .task-checkbox{
        width:18px;height:18px;
        cursor:pointer;
    }
    .cell-content{
        padding:30px 40px 0 30px;
        word-break:break-word;
        line-height:1.4;
    }
    .sub-cell-content{
        margin-left:2ch;
        padding:12px 0 0 0;
        word-break:break-word;
        line-height:1.4;
    }
    .cell-input,
    .sub-cell-input{
        width:100%;
        min-height:24px;
        border:none;
        outline:none;
        background:transparent;
        color:#e0e0e0;
        font-family:inherit;
        font-size:inherit;
        white-space:pre-wrap;
        word-break:break-word;
    }
    .cell-input::placeholder,
    .sub-cell-input::placeholder{
        color:#777;
    }
    .expand-indicator{
        width:24px;height:24px;
        border-radius:50%;
        background:#2196F3;color:#fff;
        display:flex;
        align-items:center;
        justify-content:center;
        cursor:pointer;
        font-weight:bold;
        font-size:16px;
        transition:all .2s;
    }
    .expand-indicator:hover{
        background:#0b7dda;
        transform:scale(1.1);
    }
    .legend{
        display:flex;
        justify-content:center;
        gap:20px;
        margin-top:20px;
        flex-wrap:wrap;
    }
    .legend-item{display:flex;align-items:center;gap:8px;}
    .legend-color{
        width:20px;height:20px;
        border-radius:3px;
    }
    .actions{
        display:flex;
        justify-content:center;
        gap:15px;
        margin-top:20px;
    }
    .pagination{
        display:flex;
        justify-content:center;
        align-items:center;
        gap:12px;
        margin-top:15px;
    }
    .pagination button{
        width:36px;height:36px;
        border:none;
        border-radius:6px;
        background:#2196F3;
        color:#fff;
        font-size:20px;
        cursor:pointer;
        transition:background .2s;
    }
    .pagination button:hover{background:#0b7dda;}
    .pagination button:disabled{
        background:#555;
        cursor:not-allowed;
    }
    button{
        padding:10px 20px;
        border:none;
        border-radius:6px;
        cursor:pointer;
        font-weight:600;
        transition:all .2s;
        color:#fff;
    }
    .add-task-btn{background:#2196F3;}
    .add-task-btn:hover{background:#0b7dda;}
    .reset-btn{background:#9E9E9E;}
    .reset-btn:hover{background:#757575;}
    .save-btn{background:#66BB6A;}
    .save-btn:hover{background:#4CAF50;}
    .empty-cell{
        border:1px solid #333;
        background:#2b2b2b;
    }
    .scrollbar{
        height:12px;
        margin-top:8px;
        user-select:none;
    }
    .scrollbar .track{
        width:100%;
        height:8px;
        background:#444;
        border-radius:4px;
        position:relative;
        cursor:pointer;
    }
    .scrollbar .thumb{
        height:100%;
        width:60px;
        background:#2196F3;
        border-radius:4px;
        position:absolute;
        left:0;
        top:0;
        cursor:pointer;
        transition:background .2s;
    }
    .scrollbar .thumb:hover{
        background:#0b7dda;
    }
    @media(max-width:768px){
        .table-container{padding:10px;}
        th,.task-cell,.sub-task-cell{padding:10px 5px;}
        .cell-content,.sub-cell-content{font-size:14px;padding:30px 40px 0 30px;}
    }
    .no-select{
        user-select:none;
    }
</style>
</head>
<body>
<div class="container">
    <h1>ä»»åŠ¡è¿½è¸ªè¡¨æ ¼</h1>

    <div class="instructions">
        <h2>ä½¿ç”¨è¯´æ˜</h2>
        <ul>
            <li><strong>ç‚¹å‡»æ–‡å­—å³å¯ç¼–è¾‘</strong>ï¼ˆå›è½¦æ¢è¡Œï¼‰ï¼Œå¤±ç„¦åè‡ªåŠ¨ä¿å­˜</li>
            <li><strong>å‹¾é€‰å¤é€‰æ¡†</strong>ï¼šé”å®šä»»åŠ¡çŠ¶æ€ï¼ˆä¿æŒç»¿è‰²ï¼‰</li>
            <li><strong>ç‚¹å‡»è¡¨å¤´</strong>ï¼šåªæ˜¾ç¤ºè¯¥åˆ—ä»»åŠ¡</li>
            <li><strong>åŒå‡»è¡¨å¤´</strong>ï¼šç¼–è¾‘ä»»åŠ¡ï¼ˆåˆ—ï¼‰åç§°</li>
            <li><strong>ç‚¹å‡»å·¦ä¾§ä¸‰è§’</strong>ï¼šå±•å¼€å­ä»»åŠ¡åˆ—ï¼ˆå³ä¾§å‡ºç°æ–°åˆ—ï¼Œå…¶ä»–åˆ—æ•´ä½“å³ç§»ï¼‰</li>
            <li><strong>çŠ¶æ€æŒ‡ç¤ºç¯</strong>ï¼šç»¿è‰²&lt;12â€¯hï¼Œé»„è‰²&lt;24â€¯hï¼Œçº¢è‰²â‰¥24â€¯h</li>
            <li><strong>å³é”®çŠ¶æ€å°æ–¹å—</strong>ï¼šæŸ¥çœ‹è¯¥å•å…ƒæ ¼è·ç¦»å˜ä¸ºçº¢è‰²çŠ¶æ€è¿˜æœ‰å¤šå°‘æ—¶é—´ï¼ˆæˆ–å·²è¶…è¿‡å¤šå°‘ï¼‰</li>
            <li><strong>æ‹–åŠ¨ä¸‹æ–¹è¿›åº¦æ¡</strong>å³å¯æ¨ªå‘æ»šåŠ¨è¡¨æ ¼ï¼Œä¸”ä¸ä¼šé®æŒ¡ä»»ä½•å†…å®¹</li>
            <li><strong>åˆ†é¡µ</strong>ï¼šæ¯é¡µæœ€å¤šæ˜¾ç¤º 3 é¡¹ç›®ï¼Œä½¿ç”¨ã€Œ-ã€/ã€Œ+ã€åˆ‡æ¢</li>
            <li><strong>ä¿å­˜æŒ‰é’®</strong>ï¼šç‚¹æ­¤æŠŠå½“å‰æ‰€æœ‰æ–‡å­—ã€çŠ¶æ€ã€å±•å¼€ã€åˆ†é¡µç­‰ä¿¡æ¯ä¿å­˜åˆ°æœ¬åœ°ï¼ˆlocalStorageï¼‰</li>
            <li><strong>ç¼–è¾‘å­ä»»åŠ¡å</strong>ï¼šå¯¹åº”çš„ä¸Šä¸€çº§ï¼ˆä¸»ä»»åŠ¡ï¼‰çŠ¶æ€æŒ‡ç¤ºç¯ä¼šè‡ªåŠ¨é‡ç½®ä¸ºæœ€æ–°æ—¶é—´</li>
        </ul>
    </div>

    <div class="table-wrapper">
        <div class="table-container" id="tableContainer">
            <table id="taskTable">
                <thead><tr id="headerRow"></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        <!-- è‡ªå®šä¹‰æ°´å¹³æ»šåŠ¨æ¡ -->
        <div class="scrollbar" id="customScrollbar">
            <div class="track"><div class="thumb" id="scrollThumb"></div></div>
        </div>
    </div>

    <div class="legend">
        <div class="legend-item"><div class="legend-color" style="background:#4CAF50;"></div><span>&lt;12â€¯h</span></div>
        <div class="legend-item"><div class="legend-color" style="background:#FFC107;"></div><span>&lt;24â€¯h</span></div>
        <div class="legend-item"><div class="legend-color" style="background:#F44336;"></div><span>â‰¥24â€¯h</span></div>
    </div>

    <div class="actions">
        <button class="add-task-btn" onclick="addNewTask()">+ æ·»åŠ æ–°ä»»åŠ¡</button>
        <button class="reset-btn" onclick="resetView()">é‡ç½®è§†å›¾</button>
        <button class="save-btn" onclick="saveState()">ğŸ’¾ ä¿å­˜çŠ¶æ€</button>
    </div>

    <!-- åˆ†é¡µæ§åˆ¶ -->
    <div class="pagination">
        <button class="prev-page-btn" onclick="prevPage()">âˆ’</button>
        <span id="pageInfo">ç¬¬ 1 / 1 é¡µ</span>
        <button class="next-page-btn" onclick="nextPage()">+</button>
    </div>
</div>

<script>
/* -------------------- æ•°æ®æ¨¡å‹ -------------------- */
let tasks = [
    {
        name:"é¡¹ç›®A",
        cells:[
            {content:"å®Œæˆéœ€æ±‚åˆ†æ",completed:false,lastUpdated:new Date(Date.now()-2*60*60*1000),expanded:false,subCells:[]},
            {content:"è®¾è®¡ç³»ç»Ÿæ¶æ„",completed:true,lastUpdated:new Date(Date.now()-5*60*60*1000),expanded:false,subCells:[]}
        ]
    },
    {
        name:"é¡¹ç›®B",
        cells:[
            {content:"ç¼–å†™æ ¸å¿ƒæ¨¡å—",completed:false,lastUpdated:new Date(Date.now()-15*60*60*1000),expanded:false,subCells:[]},
            {content:"å•å…ƒæµ‹è¯•",completed:false,lastUpdated:new Date(Date.now()-30*60*60*1000),expanded:false,subCells:[]}
        ]
    },
    {
        name:"æ—¥å¸¸ä»»åŠ¡",
        cells:[
            {content:"ä»£ç å®¡æŸ¥",completed:true,lastUpdated:new Date(Date.now()-8*60*60*1000),expanded:false,subCells:[]},
            {content:"å›¢é˜Ÿä¼šè®®",completed:false,lastUpdated:new Date(Date.now()-10*60*60*1000),expanded:false,subCells:[]}
        ]
    }
];

let expandedColumnIdx = null;   // å½“å‰å±•å¼€çš„ä¸»ä»»åŠ¡åˆ—ï¼ˆè‹¥æœ‰ï¼‰
let expandedCellIdx   = null;   // å¯¹åº”çš„ä¸»ä»»åŠ¡å•å…ƒæ ¼ç´¢å¼•
let currentTaskFilter = null;   // null â†’ æ˜¾ç¤ºå…¨éƒ¨
let currentPage = 0;            // å½“å‰åˆ†é¡µï¼ˆä» 0 å¼€å§‹è®¡æ•°ï¼‰
const tasksPerPage = 3;         // æ¯é¡µæœ€å¤šæ˜¾ç¤ºçš„é¡¹ç›®æ•°

/* ----------- åŒå‡»/å•å‡»è¡¨å¤´çš„è®¡æ—¶å™¨ï¼Œé˜²æ­¢å†²çª ----------- */
let headerClickTimer = null;
const headerClickDelay = 250;   // ms

/* -------------------- åˆå§‹åŒ– -------------------- */
function initTable(){
    loadState();      // è¯»å–æœ¬åœ°ä¿å­˜çš„çŠ¶æ€ï¼ˆå¦‚æœæœ‰ï¼‰
    renderTable();
    updateStatusIndicators();
    setInterval(updateStatusIndicators,30000);   // æ¯ 30â€¯s æ›´æ–°é¢œè‰²
    initCustomScrollbar();                      // ä¸ºæ¨ªå‘æ»šåŠ¨æ¡ç»‘å®šäº‹ä»¶
    updatePaginationInfo();
}
document.addEventListener('DOMContentLoaded',initTable);

/* -------------------- æœ¬åœ°æŒä¹…åŒ– -------------------- */
function saveState(){
    // æŠŠä»»åŠ¡ã€åˆ†é¡µã€å±•å¼€ã€è¿‡æ»¤ç­‰ä¿¡æ¯å…¨éƒ¨ä¿å­˜
    const data = {
        tasks: tasks,
        currentPage,
        expandedColumnIdx,
        expandedCellIdx,
        currentTaskFilter
    };
    localStorage.setItem('taskTrackerData', JSON.stringify(data));
    alert('å·²ä¿å­˜å½“å‰çŠ¶æ€');
}
function loadState(){
    const raw = localStorage.getItem('taskTrackerData');
    if(!raw) return; // æ²¡æœ‰å­˜æ¡£åˆ™ç›´æ¥ä½¿ç”¨é»˜è®¤æ•°æ®
    try{
        const obj = JSON.parse(raw);
        // æŠŠå­—ç¬¦ä¸²å½¢å¼çš„æ—¥æœŸæ¢å¤ä¸º Date å¯¹è±¡
        obj.tasks.forEach(task=>{
            task.cells.forEach(cell=>{
                cell.lastUpdated = new Date(cell.lastUpdated);
                cell.subCells.forEach(sub=>{
                    sub.lastUpdated = new Date(sub.lastUpdated);
                });
            });
        });
        tasks = obj.tasks;
        currentPage = obj.currentPage || 0;
        expandedColumnIdx = obj.expandedColumnIdx;
        expandedCellIdx   = obj.expandedCellIdx;
        currentTaskFilter = obj.currentTaskFilter;
    }catch(e){
        console.warn('è¯»å–æœ¬åœ°ä¿å­˜æ•°æ®å¤±è´¥ï¼Œå°†ä½¿ç”¨é»˜è®¤æ•°æ®ã€‚',e);
    }
}

/* -------------------- æ¸²æŸ“ -------------------- */
function renderTable(){
    const headerRow = document.getElementById('headerRow');
    const tbody    = document.getElementById('tableBody');
    headerRow.innerHTML = '';
    tbody.innerHTML    = '';

    /* ----- è®¡ç®—å¯è§åˆ—ï¼ˆåˆ†é¡µæˆ–è¿‡æ»¤ï¼‰ ----- */
    let visibleIndices;
    if(currentTaskFilter !== null){
        visibleIndices = [currentTaskFilter];
    }else{
        const start = currentPage * tasksPerPage;
        const end   = start + tasksPerPage;
        visibleIndices = tasks.map((_,i)=>i).slice(start,end);
    }

    /* ----- åˆ—é¡ºåºï¼šä¸»åˆ— +ï¼ˆè‹¥å±•å¼€ï¼‰å­ä»»åŠ¡åˆ— ----- */
    const colOrder = [];
    visibleIndices.forEach(idx=>{
        colOrder.push(idx);                // ä¸»ä»»åŠ¡åˆ—
        if(expandedColumnIdx!==null && expandedColumnIdx===idx){
            colOrder.push(`sub-${idx}`); // å¯¹åº”çš„å­ä»»åŠ¡åˆ—
        }
    });

    /* ----- è¡¨å¤´ï¼ˆå•å‡»è¿‡æ»¤ï¼ŒåŒå‡»ç¼–è¾‘ï¼‰ ----- */
    colOrder.forEach(col=>{
        const th=document.createElement('th');
        if(typeof col==='number'){
            th.textContent = tasks[col].name;

            // å•å‡» â†’ è¿‡æ»¤ï¼ˆæˆ–é‡ç½®ï¼‰
            th.addEventListener('click', e=>{
                if(headerClickTimer) clearTimeout(headerClickTimer);
                headerClickTimer = setTimeout(()=>{
                    if (currentTaskFilter!==null) resetView();
                    else filterTask(col);
                    headerClickTimer = null;
                }, headerClickDelay);
            });

            // åŒå‡» â†’ ç¼–è¾‘åˆ—æ ‡é¢˜
            th.addEventListener('dblclick', e=>{
                if(headerClickTimer){
                    clearTimeout(headerClickTimer);
                    headerClickTimer = null;
                }
                editTaskName(col);
                e.stopPropagation();
            });
        }else{
            th.textContent = tasks[expandedColumnIdx].name + ' å­ä»»åŠ¡';
            th.onclick = resetView;
        }
        headerRow.appendChild(th);
    });

    /* ----- è®¡ç®—ä¸»ä»»åŠ¡æœ€å¤§è¡Œæ•° ----- */
    let maxMainRows = 0;
    visibleIndices.forEach(i=> maxMainRows = Math.max(maxMainRows, tasks[i].cells.length));

    /* ----- æŒ‰è¡Œæ¸²æŸ“ï¼šä¸»ä»»åŠ¡è¡Œ â†’ï¼ˆè‹¥å±•å¼€ï¼‰å­ä»»åŠ¡è¡Œ ----- */
    for(let mainRowIdx=0; mainRowIdx<maxMainRows; mainRowIdx++){
        /* ä¸»ä»»åŠ¡è¡Œ */
        const trMain=document.createElement('tr');
        colOrder.forEach(col=>{
            let td;
            if(typeof col==='number'){
                const task = tasks[col];
                const cell = task.cells[mainRowIdx];
                td = cell ? createMainTaskCell(cell,col,mainRowIdx)
                         : (function(){ const d=document.createElement('td'); d.className='empty-cell'; return d; })();
            }else{
                td = document.createElement('td');   // å­ä»»åŠ¡åˆ—åœ¨ä¸»ä»»åŠ¡è¡Œé‡Œä¿æŒç©ºç™½
                td.className='empty-cell';
            }
            trMain.appendChild(td);
        });
        tbody.appendChild(trMain);

        /* å­ä»»åŠ¡è¡Œï¼ˆä»…åœ¨å±•å¼€åˆ—å¯¹åº”ä¸”è¯¥å•å…ƒæ ¼å·²å±•å¼€æ—¶å‡ºç°ï¼‰ */
        if(expandedColumnIdx!==null && visibleIndices.includes(expandedColumnIdx)){
            const expTask = tasks[expandedColumnIdx];
            const expCell = expTask.cells[mainRowIdx];
            if(expCell && expCell.expanded && expCell.subCells.length>0){
                expCell.subCells.forEach((subCell,subIdx)=>{
                    const trSub=document.createElement('tr');
                    colOrder.forEach(col=>{
                        let td;
                        if(typeof col==='number'){
                            td = document.createElement('td');
                            td.className='empty-cell';
                        }else{
                            td = createSubTaskCell(subCell,expandedColumnIdx,mainRowIdx,subIdx);
                        }
                        trSub.appendChild(td);
                    });
                    tbody.appendChild(trSub);
                });
            }
        }
    }

    updateScrollbar();          // åŒæ­¥è‡ªå®šä¹‰æ»šåŠ¨æ¡å°ºå¯¸/ä½ç½®
    updatePaginationInfo();     // åŒæ­¥åˆ†é¡µæŒ‰é’®çŠ¶æ€
}

/* -------------------- ä¸»ä»»åŠ¡å•å…ƒæ ¼ï¼ˆå¯ç¼–è¾‘ï¼‰ -------------------- */
function createMainTaskCell(cell,taskIdx,cellIdx){
    const td=document.createElement('td');
    td.className='task-cell';

    /* å¤é€‰æ¡† */
    const cbDiv=document.createElement('div');
    cbDiv.className='checkbox-container';
    const cb=document.createElement('input');
    cb.type='checkbox';
    cb.className='task-checkbox';
    cb.checked=cell.completed;
    cb.onchange=()=>toggleCompleted(taskIdx,cellIdx);
    cbDiv.appendChild(cb);
    td.appendChild(cbDiv);

    /* çŠ¶æ€æŒ‡ç¤ºç¯ï¼ˆå³é”®å¼¹å‡ºæ—¶é—´ä¿¡æ¯ï¼‰ */
    const status=document.createElement('div');
    status.className='status-indicator';
    status.id=`status-${taskIdx}-${cellIdx}`;
    status.addEventListener('contextmenu', e=>{
        e.preventDefault();
        const msg = getStatusTimeInfo(cell.lastUpdated);
        alert(msg);
    });
    td.appendChild(status);

    /* æ§åˆ¶æŒ‰é’®ï¼ˆå±•å¼€ / æ·»åŠ  / åˆ é™¤ï¼‰ */
    const ctrl=document.createElement('div');
    ctrl.className='cell-controls';

    // å±•å¼€/æ”¶èµ·æŒ‡ç¤ºå™¨
    const expand=document.createElement('div');
    expand.className='expand-indicator';
    expand.textContent=cell.expanded?'â–²':'â–¼';
    expand.title=cell.expanded?'æ”¶èµ·å­ä»»åŠ¡':'å±•å¼€å­ä»»åŠ¡';
    expand.onclick=e=>{ e.stopPropagation(); toggleSubCells(taskIdx,cellIdx); };
    ctrl.appendChild(expand);

    // æ·»åŠ æŒ‰é’®
    const addBtn=document.createElement('button');
    addBtn.className='add-cell-btn';
    addBtn.textContent='+';
    addBtn.onclick=e=>{ e.stopPropagation(); addCellBelow(taskIdx,cellIdx); };
    ctrl.appendChild(addBtn);

    // åˆ é™¤æŒ‰é’®
    const delBtn=document.createElement('button');
    delBtn.className='delete-cell-btn';
    delBtn.textContent='Ã—';
    delBtn.onclick=e=>{ e.stopPropagation(); if(confirm('ç¡®å®šè¦åˆ é™¤æ­¤ä»»åŠ¡å•å…ƒæ ¼å—ï¼Ÿ')) deleteCell(taskIdx,cellIdx); };
    ctrl.appendChild(delBtn);
    td.appendChild(ctrl);

    /* å†…å®¹ï¼ˆcontenteditableï¼‰ */
    const contentDiv=document.createElement('div');
    contentDiv.className='cell-content';
    const editable=document.createElement('div');
    editable.className='cell-input';
    editable.contentEditable='true';
    editable.innerText = cell.content;
    editable.title='ç›´æ¥ç¼–è¾‘ï¼Œå›è½¦æ¢è¡Œï¼Œå¤±ç„¦è‡ªåŠ¨ä¿å­˜';
    // ä¿å­˜é€»è¾‘ï¼ˆblurï¼‰
    const save=()=>{
        const v=editable.innerText.trimEnd();
        if(v!==''){
            cell.content=v;
            cell.lastUpdated=new Date();
        }else{
            // é˜²æ­¢æŠŠå†…å®¹åˆ ç©º
            editable.innerText = cell.content;
        }
        updateStatusIndicators();
    };
    editable.addEventListener('blur',save);
    contentDiv.appendChild(editable);
    td.appendChild(contentDiv);

    return td;
}

/* -------------------- å­ä»»åŠ¡å•å…ƒæ ¼ï¼ˆå¯ç¼–è¾‘ï¼‰ -------------------- */
function createSubTaskCell(subCell,taskIdx,parentCellIdx,subIdx){
    const td=document.createElement('td');
    td.className='sub-task-cell';

    /* å¤é€‰æ¡† */
    const cbDiv=document.createElement('div');
    cbDiv.className='checkbox-container';
    const cb=document.createElement('input');
    cb.type='checkbox';
    cb.className='task-checkbox';
    cb.checked=subCell.completed;
    cb.onchange=()=>toggleSubCompleted(taskIdx,parentCellIdx,subIdx);
    cbDiv.appendChild(cb);
    td.appendChild(cbDiv);

    /* çŠ¶æ€æŒ‡ç¤ºç¯ï¼ˆå³é”®å¼¹å‡ºæ—¶é—´ä¿¡æ¯ï¼‰ */
    const status=document.createElement('div');
    status.className='status-indicator';
    status.id=`status-${taskIdx}-${parentCellIdx}-sub${subIdx}`;
    status.addEventListener('contextmenu', e=>{
        e.preventDefault();
        const msg = getStatusTimeInfo(subCell.lastUpdated);
        alert(msg);
    });
    td.appendChild(status);

    /* æ§åˆ¶æŒ‰é’®ï¼ˆæ·»åŠ  / åˆ é™¤ï¼‰ */
    const ctrl=document.createElement('div');
    ctrl.className='cell-controls';

    const addBtn=document.createElement('button');
    addBtn.className='add-cell-btn';
    addBtn.textContent='+';
    addBtn.onclick=e=>{ e.stopPropagation(); addSubCellBelow(taskIdx,parentCellIdx,subIdx); };
    ctrl.appendChild(addBtn);

    const delBtn=document.createElement('button');
    delBtn.className='delete-cell-btn';
    delBtn.textContent='Ã—';
    delBtn.onclick=e=>{ e.stopPropagation(); if(confirm('ç¡®å®šè¦åˆ é™¤æ­¤å­ä»»åŠ¡å—ï¼Ÿ')) deleteSubCell(taskIdx,parentCellIdx,subIdx); };
    ctrl.appendChild(delBtn);
    td.appendChild(ctrl);

    /* å†…å®¹ï¼ˆcontenteditableï¼‰ */
    const contentDiv=document.createElement('div');
    contentDiv.className='sub-cell-content';
    const editable=document.createElement('div');
    editable.className='sub-cell-input';
    editable.contentEditable='true';
    editable.innerText=subCell.content;
    editable.title='ç›´æ¥ç¼–è¾‘ï¼Œå›è½¦æ¢è¡Œï¼Œå¤±ç„¦è‡ªåŠ¨ä¿å­˜';
    const save=()=>{
        const v=editable.innerText.trimEnd();
        if(v!==''){
            subCell.content=v;
            subCell.lastUpdated=new Date();   // å­ä»»åŠ¡è‡ªèº«æ›´æ–°æ—¶é—´
            // ---------- å…³é”®æ”¹åŠ¨ï¼šåŒæ­¥çˆ¶ä»»åŠ¡çš„ lastUpdated ----------
            const parentCell = tasks[taskIdx].cells[parentCellIdx];
            parentCell.lastUpdated = new Date(); // çˆ¶ä»»åŠ¡çŠ¶æ€å—é‡ç½®
        }else{
            editable.innerText=subCell.content;
        }
        updateStatusIndicators();
    };
    editable.addEventListener('blur',save);
    contentDiv.appendChild(editable);
    td.appendChild(contentDiv);

    return td;
}

/* -------------------- äº¤äº’å‡½æ•° -------------------- */
function toggleCompleted(ti,ci){
    const cell=tasks[ti].cells[ci];
    cell.completed=!cell.completed;
    renderTable();
    updateStatusIndicators();
}
function toggleSubCompleted(ti,pi,si){
    const sub=tasks[ti].cells[pi].subCells[si];
    sub.completed=!sub.completed;
    // ---------- åŒæ­¥çˆ¶ä»»åŠ¡çš„ lastUpdated ----------
    tasks[ti].cells[pi].lastUpdated = new Date();
    renderTable();
    updateStatusIndicators();
}
function addCellBelow(ti,ci){
    const newCell={content:'æ–°ä»»åŠ¡',completed:false,lastUpdated:new Date(),expanded:false,subCells:[]};
    tasks[ti].cells.splice(ci+1,0,newCell);
    renderTable();
    updateStatusIndicators();
}
function addSubCellBelow(ti,pi,si){
    const newSub={content:'æ–°å­ä»»åŠ¡',completed:false,lastUpdated:new Date()};
    tasks[ti].cells[pi].subCells.splice(si+1,0,newSub);
    // ---------- åŒæ­¥çˆ¶ä»»åŠ¡çš„ lastUpdated ----------
    tasks[ti].cells[pi].lastUpdated = new Date();
    renderTable();
    updateStatusIndicators();
}
function deleteCell(ti,ci){
    tasks[ti].cells.splice(ci,1);
    if(expandedColumnIdx===ti && expandedCellIdx===ci){
        expandedColumnIdx=null;
        expandedCellIdx=null;
    }
    renderTable();
    updateStatusIndicators();
}
function deleteSubCell(ti,pi,si){
    tasks[ti].cells[pi].subCells.splice(si,1);
    // ---------- åŒæ­¥çˆ¶ä»»åŠ¡çš„ lastUpdated ----------
    tasks[ti].cells[pi].lastUpdated = new Date();
    renderTable();
    updateStatusIndicators();
}

/* å±•å¼€/æ”¶èµ·å­ä»»åŠ¡åˆ—ï¼ˆåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªå­ä»»åŠ¡åˆ—ï¼‰ */
function toggleSubCells(ti,ci){
    const cell=tasks[ti].cells[ci];
    const willExpand=!cell.expanded;

    // å…³é—­ä¸Šä¸€æ¬¡å±•å¼€çš„åˆ—ï¼ˆè‹¥ä¸æ˜¯åŒä¸€ä¸ªå•å…ƒæ ¼ï¼‰
    if(expandedColumnIdx!==null && (expandedColumnIdx!==ti || expandedCellIdx!==ci)){
        const prevCell=tasks[expandedColumnIdx].cells[expandedCellIdx];
        if(prevCell) prevCell.expanded=false;
        expandedColumnIdx=null;
        expandedCellIdx=null;
    }

    if(willExpand){
        if(cell.subCells.length===0){
            cell.subCells.push({content:'å­ä»»åŠ¡',completed:false,lastUpdated:new Date()});
        }
        cell.expanded=true;
        expandedColumnIdx=ti;
        expandedCellIdx=ci;
    }else{
        cell.expanded=false;
        expandedColumnIdx=null;
        expandedCellIdx=null;
    }
    renderTable();
    updateStatusIndicators();
}

/* ---------- è¿‡æ»¤è§†å›¾ ---------- */
function filterTask(idx){
    currentTaskFilter=idx;
    renderTable();
}
function resetView(){
    currentTaskFilter=null;
    renderTable();
}

/* ---------- æ·»åŠ æ–°ä»»åŠ¡ï¼ˆæ–°åˆ—ï¼‰ ---------- */
function addNewTask(){
    const name=prompt('è¾“å…¥æ–°ä»»åŠ¡åç§°:');
    if(name && name.trim()){
        tasks.push({
            name:name.trim(),
            cells:[{content:'æ–°ä»»åŠ¡é¡¹',completed:false,lastUpdated:new Date(),expanded:false,subCells:[]}]
        });
        renderTable();
        updateStatusIndicators();
    }
}

/* ---------- åŒå‡»ç¼–è¾‘åˆ—æ ‡é¢˜ ---------- */
function editTaskName(idx){
    const cur = tasks[idx].name;
    const newName = prompt('ç¼–è¾‘ä»»åŠ¡åç§°ï¼ˆåˆ—æ ‡é¢˜ï¼‰:', cur);
    if(newName!==null && newName.trim()!==''){
        tasks[idx].name = newName.trim();
        renderTable();
    }
}

/* ---------- çŠ¶æ€æŒ‡ç¤ºç¯é¢œè‰²æ›´æ–° ---------- */
function updateStatusIndicators(){
    const now=Date.now();
    tasks.forEach((task,tIdx)=>{
        task.cells.forEach((cell,cIdx)=>{
            const st=document.getElementById(`status-${tIdx}-${cIdx}`);
            if(st){
                if(cell.completed){
                    st.className='status-indicator status-green';
                }else{
                    const diff=(now-cell.lastUpdated)/(1000*60*60);
                    st.className= diff<12?'status-indicator status-green':
                                 diff<24?'status-indicator status-yellow':
                                         'status-indicator status-red';
                }
            }
            // å­ä»»åŠ¡é¢œè‰²
            cell.subCells.forEach((sub,sIdx)=>{
                const sst=document.getElementById(`status-${tIdx}-${cIdx}-sub${sIdx}`);
                if(sst){
                    if(sub.completed){
                        sst.className='status-indicator status-green';
                    }else{
                        const diff=(now-sub.lastUpdated)/(1000*60*60);
                        sst.className= diff<12?'status-indicator status-green':
                                     diff<24?'status-indicator status-yellow':
                                             'status-indicator status-red';
                    }
                }
            });
        });
    });
}

/* ---------- è®¡ç®— â€œè·ç¦»çº¢è‰²çŠ¶æ€è¿˜æœ‰/å·²è¶…è¿‡å¤šå°‘æ—¶é—´â€ ---------- */
function getStatusTimeInfo(lastUpdated){
    const now = Date.now();
    const elapsedMs = now - new Date(lastUpdated).getTime();
    const elapsedHours = elapsedMs / (1000*60*60);
    const RED_THRESHOLD = 24; // å°æ—¶

    if (elapsedHours >= RED_THRESHOLD){
        const over = elapsedHours - RED_THRESHOLD;
        const h = Math.floor(over);
        const m = Math.round((over - h) * 60);
        return `å·²è¶…è¿‡çº¢è‰²çŠ¶æ€ ${h} å°æ—¶ ${m} åˆ†é’Ÿ`;
    }else{
        const remain = RED_THRESHOLD - elapsedHours;
        const h = Math.floor(remain);
        const m = Math.round((remain - h) * 60);
        return `è·ç¦»çº¢è‰²çŠ¶æ€è¿˜æœ‰ ${h} å°æ—¶ ${m} åˆ†é’Ÿ`;
    }
}

/* -------------------- è‡ªå®šä¹‰æ¨ªå‘æ»šåŠ¨æ¡ -------------------- */
function initCustomScrollbar(){
    const thumb=document.getElementById('scrollThumb');
    const track=document.querySelector('#customScrollbar .track');
    const container=document.getElementById('tableContainer');

    let isDragging=false;
    let startX=0;
    let startLeft=0;

    // æ‹–åŠ¨ thumb
    thumb.addEventListener('mousedown',e=>{
        e.preventDefault();
        isDragging=true;
        startX=e.pageX;
        const m=thumb.style.transform.match(/translateX\(([^)]+)px\)/);
        startLeft=m?parseFloat(m[1]):0;
        document.body.classList.add('no-select');
    });
    document.addEventListener('mousemove',e=>{
        if(!isDragging) return;
        const dx=e.pageX-startX;
        const trackWidth=track.clientWidth;
        const maxThumbLeft=trackWidth-thumb.offsetWidth;
        let newLeft=startLeft+dx;
        newLeft=Math.max(0,Math.min(newLeft,maxThumbLeft));
        thumb.style.transform=`translateX(${newLeft}px)`;

        // åŒæ­¥å®¹å™¨æ»šåŠ¨
        const maxScroll=container.scrollWidth-container.clientWidth;
        const scrollLeft=(newLeft/maxThumbLeft)*maxScroll;
        container.scrollLeft=scrollLeft;
    });
    document.addEventListener('mouseup',()=>{
        if(isDragging){
            isDragging=false;
            document.body.classList.remove('no-select');
        }
    });

    // ç‚¹å‡»è½¨é“è·³è½¬
    track.addEventListener('click',e=>{
        if(isDragging) return;
        const rect=track.getBoundingClientRect();
        const clickX=e.clientX-rect.left;
        const thumbWidth=thumb.offsetWidth;
        const trackWidth=track.clientWidth;
        const maxThumbLeft=trackWidth-thumbWidth;
        let newLeft=clickX-thumbWidth/2;
        newLeft=Math.max(0,Math.min(newLeft,maxThumbLeft));
        thumb.style.transform=`translateX(${newLeft}px)`;
        const maxScroll=container.scrollWidth-container.clientWidth;
        const scrollLeft=(newLeft/maxThumbLeft)*maxScroll;
        container.scrollLeft=scrollLeft;
    });
}

/* æ ¹æ®å®¹å™¨æ»šåŠ¨åŒæ­¥ thumb å¤§å°/ä½ç½® */
function updateScrollbar(){
    const container=document.getElementById('tableContainer');
    const thumb=document.getElementById('scrollThumb');
    const track=document.querySelector('#customScrollbar .track');

    const scrollWidth=container.scrollWidth;
    const clientWidth=container.clientWidth;

    if(scrollWidth<=clientWidth){
        thumb.style.display='none';
        return;
    }else{
        thumb.style.display='block';
    }

    const ratio=clientWidth/scrollWidth;
    const thumbWidth=Math.max(ratio*track.clientWidth,30);
    thumb.style.width=thumbWidth+'px';

    const maxScroll=scrollWidth-clientWidth;
    const maxThumbLeft=track.clientWidth-thumbWidth;
    const left=(container.scrollLeft/maxScroll)*maxThumbLeft;
    thumb.style.transform=`translateX(${left}px)`;
}

/* -------------------- åˆ†é¡µæ§åˆ¶ -------------------- */
function nextPage(){
    if(currentTaskFilter!==null) return; // è¿‡æ»¤çŠ¶æ€ä¸‹ä¸åˆ†é¡µ
    const totalPages=Math.ceil(tasks.length/tasksPerPage);
    if(currentPage<totalPages-1){
        currentPage++;
        // åˆ‡é¡µæ—¶è‡ªåŠ¨æ”¶èµ·å­ä»»åŠ¡åˆ—ï¼Œé˜²æ­¢ç´¢å¼•é”™è¯¯
        expandedColumnIdx=null;
        expandedCellIdx=null;
        renderTable();
    }
}
function prevPage(){
    if(currentTaskFilter!==null) return;
    if(currentPage>0){
        currentPage--;
        expandedColumnIdx=null;
        expandedCellIdx=null;
        renderTable();
    }
}
function updatePaginationInfo(){
    const pageInfo=document.getElementById('pageInfo');
    const totalPages=Math.ceil(tasks.length/tasksPerPage);
    pageInfo.textContent=`ç¬¬ ${currentPage+1} / ${totalPages} é¡µ`;

    // æŒ‰é’®å¯ç”¨æ€§
    const prevBtn=document.querySelector('.prev-page-btn');
    const nextBtn=document.querySelector('.next-page-btn');
    if(currentTaskFilter!==null){
        prevBtn.disabled=true;
        nextBtn.disabled=true;
    }else{
        prevBtn.disabled = currentPage===0;
        nextBtn.disabled = currentPage>=totalPages-1;
    }
}

/* -------------------- ç»“æŸ -------------------- */
</script>
</body>
</html>
